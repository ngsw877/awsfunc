#!/bin/bash

# Pre-commit hook: 
# 1. Cursor Rules が変更された場合に CLAUDE.md を自動更新
# 2. コマンド定義が変更された場合にドキュメントを自動更新

# Cursor Rules ファイルが変更されているかチェック
if ! git diff --cached --quiet --exit-code -- .cursor/rules/; then
    echo "Cursor Rules files changed, updating CLAUDE.md..."
    
    # Go スクリプトを実行
    if ! go run .githooks/sync-docs.go; then
        echo "Error: Failed to update CLAUDE.md"
        exit 1
    fi
    
    # CLAUDE.md が変更されていれば、ステージングエリアに追加
    if [ -f "CLAUDE.md" ]; then
        git add CLAUDE.md
        echo "CLAUDE.md has been updated and staged"
    fi
fi

# コマンド定義（cmd/配下）が変更されているかチェック
if ! git diff --cached --quiet --exit-code -- cmd/; then
    echo "Command definitions changed, updating documentation..."
    
    # ドキュメント生成
    if ! make docs; then
        echo "Error: Failed to generate documentation"
        exit 1
    fi
    
    # 生成されたドキュメントをステージングエリアに追加
    git add docs/
    echo "Documentation has been updated and staged"
fi

exit 0 